<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡πÄ‡∏Å‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß - ‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #eef5ff; margin: 0; text-align: center; color: #333; }
        .box { background: #fff; margin: 15px; padding: 20px; border-radius: 24px; box-shadow: 0 6px 18px rgba(0,0,0,0.1); }
        
        button { font-size: 18px; padding: 12px 20px; margin: 5px; border: none; border-radius: 18px; background: #2196f3; color: #fff; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.95); }
        button.back { background: #ff9800; width: 90%; }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô - ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô */
        .btn-lv { background: #d1d9e6; color: #444; border: 2px solid #b0b8c4; width: 80px; font-weight: bold; }
        .btn-lv.sel { background: #0d47a1 !important; color: #fff !important; border: 3px solid #002171 !important; transform: scale(1.1); }
        
        /* ‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠ */
        input#name { font-size: 20px; width: 160px; padding: 10px; border-radius: 15px; border: 3px solid #2196f3; text-align: center; margin-bottom: 10px; }
        
        button.num { font-size: 30px; width: 70px; height: 70px; border-radius: 50%; background: #f0f0f0; color: #333; }
        input#ans { font-size: 30px; width: 80%; padding: 10px; border-radius: 15px; border: 3px solid #2196f3; text-align: center; margin-bottom: 10px; }
        
        .timer { font-size: 26px; color: red; font-weight: bold; }
        .char { font-size: 38px; cursor: pointer; margin: 5px; padding: 8px; display: inline-block; border: 4px solid transparent; }
        .char.sel { border: 4px solid #ff9800; border-radius: 14px; background: #fff3e0; }
        
        .scoreBox { position: fixed; top: 10px; right: 10px; background: #ff9800; color: #fff; padding: 8px 15px; border-radius: 15px; z-index: 999; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ */
        .req-card { text-align: left; background: #fff; padding: 15px; margin: 10px 0; border-radius: 15px; border-left: 6px solid #ff9800; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .history-card { text-align: left; background: #f1f8e9; padding: 12px; margin: 8px 0; border-radius: 12px; border-left: 6px solid #4caf50; font-size: 14px; position: relative; }
        .badge { font-size: 11px; padding: 3px 8px; border-radius: 8px; color: white; float: right; font-weight: bold; }
        .bg-done { background: #4caf50; }
        .bg-cancel { background: #f44336; }
        
        .user-tag { background: #e3f2fd; padding: 8px 15px; border-radius: 12px; margin: 5px; cursor: pointer; display: inline-block; border: 2px solid #2196f3; font-weight: bold; }
        .btn-reset { background: #d32f2f; font-size: 14px; margin-top: 30px; width: 90%; color: #fff; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>

<div id="app-content"><div class="box" id="app">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö...</div></div>

<script>
// ------------------ Firebase Setup ------------------
const firebaseConfig = {
    apiKey: "AIzaSyD5Nhoo-gr8PopUEJK7YWRny-AY2ezKgAY",
    authDomain: "mathgamefamily.firebaseapp.com",
    databaseURL: "https://mathgamefamily-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mathgamefamily"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ------------------ Game State ------------------
let player="", avatar="üßí", level=1, answer=0, score=0, qCount=0, totalTimeBonus=0, time=120, timer=null;
const totalQ=7;
const rewards = [100, 200, 300, 500];

function loadLocal(k){ return JSON.parse(localStorage.getItem(k)||"{}") }
function saveLocal(k,v){ localStorage.setItem(k,JSON.stringify(v)) }

// ------------------ UI: Home Page ------------------
function home(){
    document.getElementById("scoreBox")?.remove();
    document.getElementById("app").innerHTML = `
        <h2 style="color:#1565c0">üë®‚Äçüë©‚Äçüëß ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</h2>
        <input id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" maxlength="10"><br><br>
        üéì <b>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô:</b> 
        <button id="lv1" class="btn-lv ${level==1?'sel':''}" onclick="pickLevel(1)">‡∏õ.1</button>
        <button id="lv2" class="btn-lv ${level==2?'sel':''}" onclick="pickLevel(2)">‡∏õ.2</button>
        <button id="lv3" class="btn-lv ${level==3?'sel':''}" onclick="pickLevel(3)">‡∏õ.3</button><br><br>
        <span id="av1" class="char ${avatar=='üßí'?'sel':''}" onclick="pickChar('üßí','av1')">üßí</span>
        <span id="av2" class="char ${avatar=='üëß'?'sel':''}" onclick="pickChar('üëß','av2')">üëß</span>
        <span id="av3" class="char ${avatar=='üë¶'?'sel':''}" onclick="pickChar('üë¶','av3')">üë¶</span><br><br>
        <button style="width:90%; background:#4caf50;" onclick="start()">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button><br>
        <button style="width:90%;" onclick="ranking()">üèÜ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ & ‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á</button><br>
        <button style="background:#673ab7;width:90%;" onclick="parentView()">üë®‚Äçüë©‚Äçüëß ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</button>
    `;
}

function pickLevel(l){ level=l; document.querySelectorAll(".btn-lv").forEach(b=>b.classList.remove("sel")); document.getElementById("lv"+l).classList.add("sel"); }
function pickChar(c, id){ avatar=c; document.querySelectorAll(".char").forEach(x=>x.classList.remove("sel")); document.getElementById(id).classList.add("sel"); }

// ------------------ Game Logic ------------------
function start(){ 
    player = document.getElementById("name").value.trim() || "‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á"; 
    score=0; qCount=0; totalTimeBonus=0; nextQ(); 
}

function updateScoreUI(){
    let sb = document.getElementById("scoreBox") || (document.body.insertAdjacentHTML("beforeend", `<div id="scoreBox" class="scoreBox"></div>`), document.getElementById("scoreBox"));
    sb.innerText = "‚≠ê " + (score+totalTimeBonus);
}

function nextQ(){
    if(qCount >= totalQ){ summary(); return; }
    qCount++; clearInterval(timer); updateScoreUI();
    let a=r(1,20), b=r(1,10), op="+";
    if(level==2){ a=r(10,80); b=r(10,50); op=Math.random()>0.5?"+":"-"; }
    else if(level==3){ a=r(2,12); b=r(2,12); op="√ó"; }
    if(op=="+") answer=a+b; if(op=="-"){if(b>a)[a,b]=[b,a]; answer=a-b;} if(op=="√ó") answer=a*b;
    
    time = 120;
    document.getElementById("app").innerHTML = `
        <div class="timer">‚è≥ <span id="t-val">${time}</span></div>
        <h1 style="font-size:45px">${a} ${op} ${b} = ?</h1>
        <input id="ans" type="number" readonly><br><br>
        <div>
            ${[1,2,3,4,5,6,7,8,9,0].map(n=>`<button class="num" onclick="document.getElementById('ans').value += ${n}">${n}</button>`).join("")}
            <button class="num" style="background:#f44336; color:#fff" onclick="document.getElementById('ans').value=''">C</button>
        </div><br>
        <button style="width:90%; background:#4caf50;" onclick="check()">‡∏ï‡∏≠‡∏ö</button>
    `;
    timer = setInterval(() => { time--; document.getElementById('t-val').innerText=time; if(time<=0)check(); }, 1000);
}
function r(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function check(){ clearInterval(timer); if(parseInt(document.getElementById("ans").value)===answer){ score+=(level*5); totalTimeBonus+=Math.floor(time/30); } nextQ(); }

function summary(){
    document.getElementById("scoreBox")?.remove();
    let final = score + totalTimeBonus;
    let s = loadLocal("scores"); s[player] = (s[player]||0) + final; saveLocal("scores", s);
    db.ref('scores/'+player).set({name:player, score:s[player]});
    document.getElementById("app").innerHTML = `<h2>üéØ ‡∏à‡∏ö‡πÄ‡∏Å‡∏°!</h2><h3>${player} ‡πÑ‡∏î‡πâ +${final} ‡πÅ‡∏ï‡πâ‡∏°</h3><button onclick="home()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>`;
}

// ------------------ Redemption System (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡πÅ‡∏•‡∏Å) ------------------
function ranking(){
    let s = loadLocal("scores");
    let h = "<h2>üèÜ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á</h2><b>1. ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏•‡∏Å? (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠):</b><br><br>";
    let names = Object.keys(s);
    if(names.length==0) h += "<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏ô‡πÄ‡∏•‡πà‡∏ô</p>";
    else {
        names.forEach(n => h += `<div class="user-tag" onclick="showRewards('${n}', ${s[n]})">${n} (‚≠ê ${s[n]})</div>`);
    }
    h += `<br><br><button class="back" onclick="home()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button>`;
    document.getElementById("app").innerHTML = h;
}

function showRewards(name, sScore){
    let h = `<h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°: ${name} (‚≠ê ${sScore})</h3><b>2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•:</b><br>`;
    rewards.forEach(r => {
        if(sScore >= r) h += `<button onclick="askItem('${name}', ${r})">‡πÉ‡∏ä‡πâ ${r} ‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏•‡∏Å</button><br>`;
        else h += `<button style="background:#ccc" disabled>${r} ‡πÅ‡∏ï‡πâ‡∏° (‡πÑ‡∏°‡πà‡∏û‡∏≠)</button><br>`;
    });
    h += `<br><button onclick="ranking()">‚¨Ö ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÅ‡∏•‡∏Å</button>`;
    document.getElementById("app").innerHTML = h;
}

function askItem(name, cost){
    let item = prompt("‡∏≠‡∏¢‡∏≤‡∏Å‡πÅ‡∏•‡∏Å‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏£‡∏±‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏ô‡∏°, ‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô, ‡∏ï‡∏¥‡πä‡∏Å‡∏ï‡πá‡∏≠‡∏Å):");
    if(!item) return;
    db.ref('requests/').push({ user: name, item: item, points: cost, status: "pending", time: new Date().toLocaleString('th-TH') });
    alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß! ‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö"); ranking();
}

// ------------------ Parent System & Reset ------------------
function parentView(){
    document.getElementById("app").innerHTML = `<h2>üë®‚Äçüë©‚Äçüëß ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ & ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h2><div id="p-list">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div><br>
    <button class="btn-reset" onclick="resetScores()">üõë ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0</button><br>
    <button class="back" onclick="home()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>`;
    
    db.ref('requests/').on('value', snap => {
        let data = snap.val(), p="", h="<hr><h4>‚úÖ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ñ‡∏≤‡∏ß‡∏£</h4>";
        if(data){
            Object.entries(data).reverse().forEach(([key, val]) => {
                let info = `<div><b>‡∏ú‡∏π‡πâ‡πÅ‡∏•‡∏Å:</b> ${val.user} | <b>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•:</b> ${val.item}<br><b>‡πÅ‡∏ï‡πâ‡∏°:</b> ${val.points} | <b>‡πÄ‡∏ß‡∏•‡∏≤:</b> ${val.time}</div>`;
                if(val.status === "pending"){
                    p += `<div class="req-card">${info}<br>
                        <button style="background:#4caf50;font-size:14px" onclick="decide('${key}',true)">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button> 
                        <button style="background:#f44336;font-size:14px" onclick="decide('${key}',false)">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div>`;
                } else {
                    let c = val.status==="approved"?"bg-done":"bg-cancel";
                    h += `<div class="history-card"><span class="badge ${c}">${val.status==="approved"?"‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß":"‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô"}</span>${info}</div>`;
                }
            });
        }
        document.getElementById("p-list").innerHTML = "<h4>‚è≥ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h4>" + (p || "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á</p>") + h;
    });
}

function decide(key, ok){
    if(prompt("‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á (0932815229):") !== "0932815229") return alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î!");
    if(ok){
        db.ref('requests/'+key).once('value', sn => {
            let r = sn.val();
            db.ref('scores/'+r.user).once('value', sSn => {
                let cur = sSn.val().score;
                if(cur >= r.points){
                    db.ref('scores/'+r.user+'/score').set(cur - r.points);
                    db.ref('requests/'+key+'/status').set("approved");
                    alert("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏´‡∏±‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                } else alert("‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏´‡∏±‡∏Å!");
            });
        });
    } else db.ref('requests/'+key+'/status').set("rejected");
}

function resetScores(){
    if(prompt("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0?\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:") === "0932815229"){
        db.ref('scores/').remove();
        db.ref('requests/').remove(); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        localStorage.setItem("scores", "{}");
        alert("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
        home();
    } else alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
}

window.onload = home;
</script>
</body>
</html>