<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡πÄ‡∏Å‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß - Online Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2196f3">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <style>
        body { font-family: 'Sarabun', sans-serif; background: #eef5ff; margin: 0; text-align: center; color: #333; }
        .box { background: #fff; margin: 15px; padding: 20px; border-radius: 24px; box-shadow: 0 6px 18px rgba(0,0,0,0.1); }
        button { font-size: 18px; padding: 12px 20px; margin: 5px; border: none; border-radius: 18px; background: #2196f3; color: #fff; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.95); }
        button.back { background: #ff9800; width: 90%; }
        .btn-lv { background: #d1d9e6; color: #444; border: 2px solid #b0b8c4; width: 80px; font-weight: bold; }
        .btn-lv.sel { background: #0d47a1 !important; color: #fff !important; border: 3px solid #002171 !important; transform: scale(1.1); }
        input#name { font-size: 20px; width: 160px; padding: 10px; border-radius: 15px; border: 3px solid #2196f3; text-align: center; margin-bottom: 10px; }
        button.num { font-size: 30px; width: 70px; height: 70px; border-radius: 50%; background: #f0f0f0; color: #333; }
        input#ans { font-size: 35px; width: 80%; padding: 10px; border-radius: 15px; border: 3px solid #2196f3; text-align: center; margin-bottom: 10px; background: #fff; }
        .timer { font-size: 26px; color: red; font-weight: bold; margin-bottom: 10px; }
        .char { font-size: 38px; cursor: pointer; margin: 5px; padding: 8px; display: inline-block; border: 4px solid transparent; }
        .char.sel { border: 4px solid #ff9800; border-radius: 14px; background: #fff3e0; }
        .scoreBox { position: fixed; top: 10px; right: 10px; background: #ff9800; color: #fff; padding: 8px 15px; border-radius: 15px; z-index: 999; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .req-card { text-align: left; background: #fff; padding: 15px; margin: 10px 0; border-radius: 15px; border-left: 6px solid #ff9800; }
        .history-card { text-align: left; background: #f1f8e9; padding: 12px; margin: 8px 0; border-radius: 12px; border-left: 6px solid #4caf50; font-size: 14px; }
        .badge { font-size: 11px; padding: 3px 8px; border-radius: 8px; color: white; float: right; }
        .bg-done { background: #4caf50; } .bg-cancel { background: #f44336; }
        .user-tag { background: #e3f2fd; padding: 12px 15px; border-radius: 15px; margin: 8px auto; cursor: pointer; border: 2px solid #2196f3; width: 85%; display: flex; justify-content: space-between; align-items: center; }
        .rank-num { background: #2196f3; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .btn-reset { background: #d32f2f; font-size: 14px; margin-top: 30px; width: 90%; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>

<div id="app-content">
    <div class="box" id="app">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå...</div>
</div>

<script>
// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase
const firebaseConfig = {
    apiKey: "AIzaSyD5Nhoo-gr8PopUEJK7YWRny-AY2ezKgAY",
    authDomain: "mathgamefamily.firebaseapp.com",
    databaseURL: "https://mathgamefamily-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mathgamefamily"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let player="", avatar="üßí", level=1, answer=0, score=0, qCount=0, totalTimeBonus=0, time=120, timer=null;
const totalQ=7;
const rewards = [100, 200, 300, 500, 1000];

function home(){
    document.getElementById("scoreBox")?.remove();
    document.getElementById("app").innerHTML = `
        <h2 style="color:#1565c0">üë®‚Äçüë©‚Äçüëß ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h2>
        <input id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" maxlength="10" value="${player}"><br><br>
        üéì <b>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô:</b> 
        <button id="lv1" class="btn-lv ${level==1?'sel':''}" onclick="pickLevel(1)">‡∏õ.1</button>
        <button id="lv2" class="btn-lv ${level==2?'sel':''}" onclick="pickLevel(2)">‡∏õ.2</button>
        <button id="lv3" class="btn-lv ${level==3?'sel':''}" onclick="pickLevel(3)">‡∏õ.3</button><br><br>
        <span id="av1" class="char ${avatar=='üßí'?'sel':''}" onclick="pickChar('üßí','av1')">üßí</span>
        <span id="av2" class="char ${avatar=='üëß'?'sel':''}" onclick="pickChar('üëß','av2')">üëß</span>
        <span id="av3" class="char ${avatar=='üë¶'?'sel':''}" onclick="pickChar('üë¶','av3')">üë¶</span><br><br>
        <button style="width:90%; background:#4caf50;" onclick="start()">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button><br>
        <button style="width:90%;" onclick="ranking()">üèÜ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</button><br>
        <button style="background:#673ab7;width:90%;" onclick="parentView()">üë®‚Äçüë©‚Äçüëß ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</button>
    `;
}

function pickLevel(l){ level=l; document.querySelectorAll(".btn-lv").forEach(b=>b.classList.remove("sel")); document.getElementById("lv"+l).classList.add("sel"); }
function pickChar(c, id){ avatar=c; document.querySelectorAll(".char").forEach(x=>x.classList.remove("sel")); document.getElementById(id).classList.add("sel"); }

function start(){ 
    player = document.getElementById("name").value.trim() || "‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"; 
    score=0; qCount=0; totalTimeBonus=0; 
    nextQ(); 
}

function nextQ(){
    if(qCount >= totalQ){ summary(); return; }
    qCount++; 
    clearInterval(timer);
    updateScoreUI();
    
    let a, b, op="+";
    if(level==1){ a=r(1,20); b=r(1,10); op="+"; }
    else if(level==2){ a=r(10,90); b=r(10,50); op=Math.random()>0.5?"+":"-"; }
    else if(level==3){ a=r(2,12); b=r(2,12); op="√ó"; }

    if(op=="+") answer=a+b; 
    if(op=="-"){ if(b>a)[a,b]=[b,a]; answer=a-b; } 
    if(op=="√ó") answer=a*b;
    
    time = 120;
    document.getElementById("app").innerHTML = `
        <div class="timer">‚è≥ <span id="t-val">${time}</span> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
        <div style="font-size:18px; color:#666">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${qCount} / ${totalQ}</div>
        <h1 style="font-size:55px; margin:10px 0;">${a} ${op} ${b}</h1>
        <input id="ans" type="number" readonly placeholder="?"><br><br>
        <div>
            ${[1,2,3,4,5,6,7,8,9,0].map(n=>`<button class="num" onclick="press(${n})">${n}</button>`).join("")}
            <button class="num" style="background:#f44336; color:#fff" onclick="document.getElementById('ans').value=''">C</button>
        </div><br>
        <button style="width:90%; background:#4caf50; height:60px; font-size:24px;" onclick="check()">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
    `;
    timer = setInterval(() => { 
        time--; 
        document.getElementById('t-val').innerText=time; 
        if(time<=0) check(); 
    }, 1000);
}

function press(n){ document.getElementById('ans').value += n; }
function r(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

function updateScoreUI(){
    let sb = document.getElementById("scoreBox") || (document.body.insertAdjacentHTML("beforeend", `<div id="scoreBox" class="scoreBox"></div>`), document.getElementById("scoreBox"));
    sb.innerText = "‚≠ê " + (score+totalTimeBonus);
}

function check(){
    clearInterval(timer);
    let userAns = parseInt(document.getElementById("ans").value);
    if(userAns === answer){
        score += (level*10);
        totalTimeBonus += Math.floor(time/20);
        nextQ();
    } else {
        document.getElementById("app").innerHTML = `
            <h2 style="color:red">‚ùå ‡∏ú‡∏¥‡∏î‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß!</h2>
            <h1 style="font-size:30px">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠ <span style="color:green; font-size:50px">${answer}</span></h1>
            <button style="width:90%; background:#2196f3;" onclick="nextQ()">‡∏™‡∏π‡πâ‡∏ï‡πà‡∏≠‡πÑ‡∏õ! ‚ñ∂</button>
        `;
    }
}

function summary(){
    document.getElementById("scoreBox")?.remove();
    let finalRoundScore = score + totalTimeBonus;
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    db.ref('scores/'+player).once('value', snap => {
        let oldScore = snap.exists() ? snap.val().score : 0;
        let newTotal = oldScore + finalRoundScore;
        
        db.ref('scores/'+player).set({
            name: player,
            score: newTotal,
            avatar: avatar,
            lastPlayed: new Date().toLocaleString('th-TH')
        });

        document.getElementById("app").innerHTML = `
            <div style="padding:20px;">
                <h2 style="color:#4caf50">üéä ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏¢‡∏≠‡∏î!</h2>
                <h1 style="font-size:60px">${avatar}</h1>
                <h3>‡∏Ñ‡∏∏‡∏ì ${player}</h3>
                <p>‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡πÑ‡∏î‡πâ: <b>+${finalRoundScore}</b> ‡πÅ‡∏ï‡πâ‡∏°</p>
                <h2 style="color:#0d47a1">‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${newTotal.toLocaleString()} ‚≠ê</h2>
                <button style="width:90%; background:#2196f3;" onclick="ranking()">üèÜ ‡∏î‡∏π‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</button><br>
                <button style="width:90%; background:#607d8b;" onclick="home()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
            </div>
        `;
    });
}

function ranking(){
    document.getElementById("app").innerHTML = `
        <h2 style="color:#0d47a1">üèÜ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h2>
        <div id="leaderboard" style="min-height:200px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏î...</div>
        <br>
        <button class="back" onclick="home()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button>
    `;

    // ‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Real-time ‡∏à‡∏≤‡∏Å Firebase
    db.ref('scores/').orderByChild('score').on('value', snap => {
        let list = [];
        snap.forEach(child => { list.push(child.val()); });
        list.reverse(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢

        let h = "";
        list.forEach((u, i) => {
            let badge = i==0 ? "ü•á" : i==1 ? "ü•à" : i==2 ? "ü•â" : (i+1);
            h += `
                <div class="user-tag" onclick="showRewards('${u.name}', ${u.score})">
                    <div style="display:flex; align-items:center;">
                        <div class="rank-num">${badge}</div>
                        <span style="margin-left:10px; font-weight:bold;">${u.avatar || 'üßí'} ${u.name}</span>
                    </div>
                    <b style="color:#1565c0">${u.score.toLocaleString()} ‚≠ê</b>
                </div>
            `;
        });
        document.getElementById("leaderboard").innerHTML = h || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô";
    });
}

function showRewards(name, sScore){
    let h = `<h3>${name} ‡∏°‡∏µ ‚≠ê ${sScore}</h3><b>‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•:</b><br><br>`;
    rewards.forEach(r => {
        if(sScore >= r) h += `<button style="width:80%; background:#4caf50;" onclick="askItem('${name}', ${r})">‡πÉ‡∏ä‡πâ ${r} ‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á</button><br>`;
        else h += `<button style="width:80%; background:#ccc" disabled>${r} ‡πÅ‡∏ï‡πâ‡∏° (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠)</button><br>`;
    });
    h += `<br><button class="back" onclick="ranking()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</button>`;
    document.getElementById("app").innerHTML = h;
}

function askItem(name, cost){
    let item = prompt("‡∏≠‡∏¢‡∏≤‡∏Å‡πÅ‡∏•‡∏Å‡∏≠‡∏∞‡πÑ‡∏£? (‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏≠‡∏ï‡∏¥‡∏°, ‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô, ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°):");
    if(!item) return;
    db.ref('requests/').push({ 
        user: name, item: item, points: cost, status: "pending", time: new Date().toLocaleString('th-TH') 
    });
    alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏û‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö!"); 
    ranking();
}

function parentView(){
    let pass = prompt("‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á:");
    if(pass !== "0932815229") return alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");

    document.getElementById("app").innerHTML = `
        <h2>üë®‚Äçüë©‚Äçüëß ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</h2>
        <div id="p-list">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</div><br>
        <button class="btn-reset" onclick="resetScores()">üõë ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button><br>
        <button class="back" onclick="home()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button>
    `;

    db.ref('requests/').on('value', snap => {
        let data = snap.val(), p="", h="<hr><h4>‚úÖ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</h4>";
        if(data){
            Object.entries(data).reverse().forEach(([key, val]) => {
                let info = `<div><b>‡∏ú‡∏π‡πâ‡πÅ‡∏•‡∏Å:</b> ${val.user}<br><b>‡∏Ç‡∏≠‡∏á:</b> ${val.item} (${val.points} ‡πÅ‡∏ï‡πâ‡∏°)</div>`;
                if(val.status === "pending"){
                    p += `<div class="req-card">${info}<br>
                        <button style="background:#4caf50" onclick="decide('${key}',true)">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button> 
                        <button style="background:#f44336" onclick="decide('${key}',false)">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                    </div>`;
                } else {
                    let c = val.status==="approved"?"bg-done":"bg-cancel";
                    h += `<div class="history-card"><span class="badge ${c}">${val.status==="approved"?"‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à":"‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"}</span>${info}</div>`;
                }
            });
        }
        document.getElementById("p-list").innerHTML = "<h4>‚è≥ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h4>" + (p || "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á</p>") + h;
    });
}

function decide(key, ok){
    if(ok){
        db.ref('requests/'+key).once('value', sn => {
            let r = sn.val();
            db.ref('scores/'+r.user).once('value', sSn => {
                let cur = sSn.val().score;
                if(cur >= r.points){
                    db.ref('scores/'+r.user+'/score').set(cur - r.points);
                    db.ref('requests/'+key+'/status').set("approved");
                } else alert("‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏´‡∏±‡∏Å!");
            });
        });
    } else db.ref('requests/'+key+'/status').set("rejected");
}

function resetScores(){
    if(confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){
        db.ref('scores/').remove(); 
        db.ref('requests/').remove();
        alert("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); home();
    }
}

// ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Service Worker ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ‡πÑ‡∏î‡πâ
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
            .then(reg => console.log('Service Worker registered'))
            .catch(err => console.log('Service Worker failed', err));
    });
}

window.onload = home;
</script>
</body>

</html>
