<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡πÄ‡∏Å‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2196f3">

<style>
body{font-family:sans-serif;background:#eef5ff;margin:0;text-align:center}
.box{background:#fff;margin:16px;padding:20px;border-radius:24px;box-shadow:0 6px 18px rgba(0,0,0,.2)}
button{font-size:20px;padding:14px 22px;margin:6px;border:none;border-radius:20px;background:#2196f3;color:#fff}
button.back{background:#ff9800;width:90%}
button.num{font-size:32px;width:80px;height:80px;border-radius:50%}
input{font-size:40px;width:240px;padding:14px;border-radius:18px;border:4px solid #2196f3;text-align:center}
.timer{font-size:26px;color:red}
.char{font-size:38px;cursor:pointer;margin:6px}
.sel{border:4px solid orange;border-radius:14px}
.scoreBox{position:fixed;top:12px;right:16px;background:#ff9800;color:#fff;font-size:28px;padding:10px 18px;border-radius:18px;box-shadow:0 4px 10px rgba(0,0,0,.3);z-index:999;}
</style>
</head>
<body>
<div class="box" id="app">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>

<script>
// --- ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Å‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ) ---
let player="", avatar="üßí", level=1;
let answer=0, score=0, qCount=0;
let time=120, timer=null, totalTimeBonus=0;
const totalQ=7;
const rewards=[100,150,200,250,300,350,400,450,500];

function load(k){return JSON.parse(localStorage.getItem(k)||"{}")}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function clap(){ new Audio("https://actions.google.com/sounds/v1/human_voices/applause.ogg").play(); }
window.onload=home;

function home(){
 document.getElementById("scoreBox")?.remove();
 document.getElementById("app").innerHTML=`
 <h2>üë®‚Äçüë©‚Äçüëß ‡πÄ‡∏Å‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç</h2>
 <input id="name" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠"><br><br>
 üéì ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö<br>
 <button onclick="pickLevel(1,this)">‡∏õ.1</button>
 <button onclick="pickLevel(2,this)">‡∏õ.2</button>
 <button onclick="pickLevel(3,this)">‡∏õ.3</button><br><br>
 ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£<br>
 <span class="char" onclick="pickChar('üßí',this)">üßí</span>
 <span class="char" onclick="pickChar('üëß',this)">üëß</span>
 <span class="char" onclick="pickChar('üë¶',this)">üë¶</span><br><br>
 <button onclick="start()">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
 <button onclick="ranking()">üèÜ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
 `;
}

function pickLevel(l,e){ level=l; document.querySelectorAll("button").forEach(b=>b.classList.remove("sel")); e.classList.add("sel"); }
function pickChar(c,e){ avatar=c; document.querySelectorAll(".char").forEach(x=>x.classList.remove("sel")); e.classList.add("sel"); }

function start(){ player=document.getElementById("name").value||"‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏Å‡πà‡∏á"; score=0;qCount=0;totalTimeBonus=0; nextQ(); }

function nextQ(){
 if(qCount>=totalQ){summary();return;}
 qCount++; clearInterval(timer);
 let a,b,op;
 let ops=level==1?["+"]:level==2?["+","-","√ó"]:["+","-","√ó","√∑"];
 op=ops[Math.floor(Math.random()*ops.length)];
 if(level==1){a=r(1,20);b=r(1,20)}
 if(level==2){a=r(1,100);b=r(1,100);if(op=="√ó"){a=r(2,9);b=r(1,9)}}
 if(level==3){if(op=="√∑"){b=r(2,10);answer=r(1,10);a=b*answer}else{a=r(1,100);b=r(1,100)}}
 if(op=="+")answer=a+b; if(op=="-"){if(b>a)[a,b]=[b,a];answer=a-b} if(op=="√ó")answer=a*b
 time=120;
 document.body.insertAdjacentHTML("beforeend", `<div id="scoreBox" class="scoreBox">‚≠ê ${score+totalTimeBonus}</div>`);
 document.getElementById("app").innerHTML=`
 <div class="timer">‚è≥ ${time}</div>
 <h1>${avatar}</h1>
 <h2>‡∏Ç‡πâ‡∏≠ ${qCount}/${totalQ} (‡∏õ.${level})</h2>
 <h2>${a} ${op} ${b} = ?</h2>
 <input id="ans" readonly><br><br>
 ${[1,2,3,4,5,6,7,8,9,0].map(n=>`<button class="num" onclick="add(${n})">${n}</button>`).join("")}
 <button class="num" onclick="clr()">‚å´</button><br><br>
 <button onclick="check()">‡∏ï‡∏≠‡∏ö</button>
 `;
 timer=setInterval(()=>{ time--; document.querySelector(".timer").innerText="‚è≥ "+time; if(time<=0) wrong(); },1000);
}
function r(a,b){return Math.floor(Math.random()*(b-a+1))+a}
function add(n){ans.value+=n} function clr(){ans.value=ans.value.slice(0,-1)}
function updateScore(){document.getElementById("scoreBox").innerText="‚≠ê "+(score+totalTimeBonus);}
function check(){clearInterval(timer); if(parseInt(ans.value)===answer){score+=(level==1?1:level==2?3:5); totalTimeBonus+=Math.floor(time/10); updateScore(); nextQ();}else wrong();}
function wrong(){clap(); document.getElementById("app").innerHTML=`<h2>‚ùå ‡∏ú‡∏¥‡∏î‡∏à‡πâ‡∏≤</h2><h1>üéâ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠ ${answer}</h1><button onclick="nextQ()">‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>`;}
function summary(){
  document.getElementById("scoreBox")?.remove(); 
  score+=totalTimeBonus; 
  let s=load("scores"); 
  s[player]=(s[player]||0)+score; 
  save("scores",s); 

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏û‡πà‡∏≠‡∏î‡∏π‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  if(typeof sendScore === "function") sendScore(player, s[player]); 

  document.getElementById("app").innerHTML=`<h2>üéØ ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏£‡∏ö ${totalQ} ‡∏Ç‡πâ‡∏≠</h2>...`;
}
function ranking() {
    let s = load("scores");
    let history = load("redeemHistory");
    if (!Array.isArray(history)) history = [];

    let h = "<h2>üèÜ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2><div class='rank'>";
    Object.entries(s).sort((a, b) => b[1] - a[1]).forEach((p, i) => h += `${i + 1}. ${p[0]} ‚≠ê ${p[1]}<br>`);
    
    h += "</div><hr><h3>üéÅ ‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á</h3><div class='shop'>";
    rewards.forEach(r => h += `‚≠ê ${r} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô <button onclick="redeemSelect(${r})">üéÅ ‡πÅ‡∏•‡∏Å</button><br>`);
    
    h += "</div><hr><h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å</h3><div style='text-align:left; font-size:14px; padding:10px; max-height:200px; overflow-y:auto;'>";
    
    if(history.length === 0) {
        h += "<p style='text-align:center'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á</p>";
    } else {
        // ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
        history.reverse().forEach(item => {
            h += `‚Ä¢ <b>${item.user}</b> ‡πÉ‡∏ä‡πâ ${item.points} ‡πÅ‡∏ï‡πâ‡∏° <br> <small style='color:gray'>(${item.date})</small><br>`;
        });
    }

    h += `</div><br><button onclick="resetScore()">‚ôª ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button><button class="back" onclick="home()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button>`;
    document.getElementById("app").innerHTML = h;
}
function redeemSelect(cost){let s=load("scores"); let names=Object.keys(s); if(names.length==0){alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô");return;} let list=names.map((n,i)=>`${i+1}. ${n} (${s[n]} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)`).join("\n"); let c=prompt("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏•‡∏Å (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç)\n\n"+list); let idx=parseInt(c)-1; if(!names[idx])return; redeemFor(names[idx],cost);}
function redeemFor(name, cost) {
    let s = load("scores");
    if (s[name] < cost) { alert(name + " ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠"); return; }
    
    if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á\n\n${name}\n‡πÉ‡∏ä‡πâ ${cost} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`)) {
        s[name] -= cost;
        save("scores", s);

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å‡∏û‡πà‡∏≠‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á
        if(typeof sendScore === "function") sendScore(name, s[name]); 

        // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏û‡πà‡∏≠) ...
        alert("üéâ ‡πÅ‡∏•‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        ranking();
    }
}
function resetScore(){
    let p = prompt("‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô");
    if(p === "0932815229"){
        localStorage.removeItem("scores");
        localStorage.removeItem("redeemHistory"); // ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏î‡πâ‡∏ß‡∏¢
        alert("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß");
        home();
    } else {
        alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    }
}

// --- ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô service worker ---
if ("serviceWorker" in navigator) {navigator.serviceWorker.register("service-worker.js");}
</script>
<script type="module">
  // 1. ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏à‡∏≤‡∏Å Google
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  // 2. *** ‡∏ß‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏û‡πà‡∏≠‡∏Å‡πä‡∏≠‡∏õ‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 24 ‡∏ó‡∏±‡∏ö‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ***
  const firebaseConfig = {
    apiKey: "AIzaSyD5Nhoo-gr8PopUEJK7YWRny-AY2ezKgAY",
    authDomain: "mathgamefamily.firebaseapp.com",
    databaseURL: "https://mathgamefamily-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mathgamefamily",
    storageBucket: "mathgamefamily.firebasestorage.app",
    messagingSenderId: "445996606336",
    appId: "1:445996606336:web:94651592279f012c779765",
    measurementId: "G-G0K1YVW0XX"
  };

  // 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)
  window.sendScore = function(name, score) {
    set(ref(db, 'scores/' + name), {
      name: name,
      score: score,
      time: new Date().toLocaleString()
    });
  };

  // ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏î‡πâ‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏û‡πà‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  const monitor = document.createElement('div');
  monitor.style = "position:fixed; top:10px; right:10px; background:white; border:2px solid #ff9800; padding:10px; border-radius:10px; z-index:9999; font-family:sans-serif; box-shadow:0 4px 8px rgba(0,0,0,0.2);";
  document.body.appendChild(monitor);

  onValue(ref(db, 'scores/'), (snapshot) => {
    const data = snapshot.val();
    monitor.innerHTML = '<b>üì¢ ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏π‡∏Å:</b><br>';
    if (data) {
      Object.values(data).forEach(item => {
        monitor.innerHTML += `‚úÖ ${item.name}: ${item.score} ‡πÅ‡∏ï‡πâ‡∏°<br>`;
      });
    } else {
      monitor.innerHTML += '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≤';
    }
  });
</script>
</body>
</html>

